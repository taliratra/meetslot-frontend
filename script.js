// -----------------------------------------------------
// 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// -----------------------------------------------------

const PRIZES = [
    "üéÅ 6000 meet-–±–æ–Ω—É—Å–æ–≤",
    "üéÅ 5000 meet-–±–æ–Ω—É—Å–æ–≤",
    "üéÅ 4000 meet-–±–æ–Ω—É—Å–æ–≤",
    "üéÅ 3000 meet-–±–æ–Ω—É—Å–æ–≤",
    "üéÅ 2000 meet-–±–æ–Ω—É—Å–æ–≤",
    "üéÅ 1000 meet-–±–æ–Ω—É—Å–æ–≤",
    "üöö –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –¥–æ—Å—Ç–∞–≤–∫—É",
    "üëë –°–∫–∏–¥–∫–∞ 10% (–æ—Ç 20 000 ‚ÇΩ)",
    "üëë –°–∫–∏–¥–∫–∞ 15% (–æ—Ç 25 000 ‚ÇΩ)",
    "üî• SoleFresh –∫ –∑–∞–∫–∞–∑—É"
];
const NUM_SECTORS = PRIZES.length;
const SECTOR_ANGLE = 360 / NUM_SECTORS; // 36 –≥—Ä–∞–¥—É—Å–æ–≤ –Ω–∞ —Å–µ–∫—Ç–æ—Ä

// URL –≤–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥ API –Ω–∞ Railway (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π URL!)
const API_BASE_URL = 'https://meetslot-api-backend-production.up.railway.app';

// -----------------------------------------------------
// 2. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –≠–õ–ï–ú–ï–ù–¢–´
// -----------------------------------------------------

const wheel = document.getElementById('wheel');
const spinButton = document.getElementById('spinButton');
const resultModal = document.getElementById('resultModal');
const prizeText = document.getElementById('prizeText');
let isSpinning = false;

// -----------------------------------------------------
// 3. –§–£–ù–ö–¶–ò–ò –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø –° TELEGRAM
// -----------------------------------------------------

/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–ø–∏–Ω–∞.
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ Mini App.
 */
function initTelegramApp() {
    try {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç –∫–Ω–æ–ø–∫–∏ –∏ —Ñ–æ–Ω, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
        window.Telegram.WebApp.ready();
        const Button = window.Telegram.WebApp.MainButton;
        Button.setText("–ó–∞–∫—Ä—ã—Ç—å —Ä—É–ª–µ—Ç–∫—É");
        Button.onClick(() => window.Telegram.WebApp.close());
        Button.show();

        console.log("Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ.");

        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—Ä–æ—Å –∫ API_BASE_URL
        // –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Å–ø–∏–Ω —Å–µ–≥–æ–¥–Ω—è (—Å–º. handleSpinClick)

    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp. –ó–∞–ø—É—â–µ–Ω–æ –Ω–µ –≤ Telegram.", e);
        // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤ Telegram
    }
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.
 * @returns {Promise<number|null>} –ò–Ω–¥–µ–∫—Å —Å–µ–∫—Ç–æ—Ä–∞ –¥–ª—è –≤—ã–∏–≥—Ä—ã—à–∞ –∏–ª–∏ null.
 */
async function getSpinResultFromBackend() {
    // –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –∑–∞–≥–ª—É—à–∫–∞! –í —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ –≤–∞–º –Ω—É–∂–Ω–æ:
    // 1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–∞—à –±—ç–∫–µ–Ω–¥ (API_BASE_URL + '/check_and_spin')
    // 2. –ü–µ—Ä–µ–¥–∞—Ç—å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –∏–ª–∏ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞ window.Telegram.WebApp.initData
    // 3. –ë—ç–∫–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
    //    a) –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏—Å–ø–æ–ª—å–∑—É—è initData)
    //    b) –ö—Ä—É—Ç–∏–ª –ª–∏ –æ–Ω —Å–µ–≥–æ–¥–Ω—è (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π ID –∏–∑ –ë–î)
    //    c) –ï—Å–ª–∏ –Ω–µ—Ç, –≤—ã–±—Ä–∞—Ç—å –ø—Ä–∏–∑, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î –∏ –≤–µ—Ä–Ω—É—Ç—å –µ–≥–æ –∏–Ω–¥–µ–∫—Å.

    // --- –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–ò ---
    console.log("–ó–∞–ø—Ä–æ—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥...");
    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –ø—Ä–∏–∑
    const randomIndex = Math.floor(Math.random() * NUM_SECTORS);
    await new Promise(resolve => setTimeout(resolve, 500)); // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–µ—Ç–∏

    // –ò–º–∏—Ç–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∫—Ä—É—Ç–∏–ª
    // if (localStorage.getItem('lastSpinDate') === new Date().toDateString()) {
    //    alert("–í—ã —É–∂–µ –∫—Ä—É—Ç–∏–ª–∏ —Å–µ–≥–æ–¥–Ω—è! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≤—Ç—Ä–∞.");
    //    return null;
    // }

    // localStorage.setItem('lastSpinDate', new Date().toDateString());
    return randomIndex; // –ò–Ω–¥–µ–∫—Å –æ—Ç 0 –¥–æ 9
    // --- –ö–æ–Ω–µ—Ü –ó–∞–≥–ª—É—à–∫–∏ ---
}

// -----------------------------------------------------
// 4. –õ–û–ì–ò–ö–ê –†–£–õ–ï–¢–ö–ò
// -----------------------------------------------------

/**
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ –Ω–∞–∂–∞—Ç–∏—é –∫–Ω–æ–ø–∫–∏ "–ò—Å–ø—ã—Ç–∞—Ç—å –£–¥–∞—á—É!".
 */
async function handleSpinClick() {
    if (isSpinning) return;
    isSpinning = true;
    spinButton.disabled = true;

    // 1. –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–∏–Ω–¥–µ–∫—Å –≤—ã–∏–≥—Ä—ã—à–Ω–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞) –æ—Ç –±—ç–∫–µ–Ω–¥–∞
    const winningIndex = await getSpinResultFromBackend();

    if (winningIndex === null) {
        // –°–ø–∏–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∫—Ä—É—Ç–∏–ª)
        isSpinning = false;
        spinButton.disabled = false;
        return;
    }

    // 2. –í—ã—á–∏—Å–ª—è–µ–º —É–≥–æ–ª, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –ø–æ–≤–µ—Ä–Ω—É—Ç—å —Ä—É–ª–µ—Ç–∫—É
    const baseRotations = 5; // –ú–∏–Ω–∏–º—É–º 5 –ø–æ–ª–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤
    // –£–≥–æ–ª —Å–µ–∫—Ç–æ—Ä–∞: 360 / 10 = 36 –≥—Ä–∞–¥—É—Å–æ–≤.
    // –£–≥–æ–ª –≤—ã–∏–≥—Ä—ã—à–∞: (NUM_SECTORS - 1 - winningIndex) * SECTOR_ANGLE
    // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º NUM_SECTORS - 1, –ø–æ—Ç–æ–º—É —á—Ç–æ 0-–π —Å–µ–∫—Ç–æ—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–≤–µ—Ä—Ö—É.
    const degreesToWin = (NUM_SECTORS - winningIndex - 0.5) * SECTOR_ANGLE;

    // –£–≥–æ–ª –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è
    const finalRotation = (baseRotations * 360) + degreesToWin;

    // 3. –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤—Ä–∞—â–µ–Ω–∏—è
    wheel.style.transition = 'transform 5s cubic-bezier(0.2, 0.8, 0.2, 1)';
    wheel.style.transform = `rotate(${finalRotation}deg)`;

    // 4. –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
    setTimeout(() => {
        // 5. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const prize = PRIZES[winningIndex];
        showModal(prize);

        // 6. –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        isSpinning = false;
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∫–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è disabled –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
        // spinButton.disabled = false; // <-- –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

        // –í–ê–ñ–ù–û: –ó–¥–µ—Å—å —Ç–∞–∫–∂–µ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥
        // (–Ω–∞–ø—Ä–∏–º–µ—Ä, '/log_win'), —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∏–∑–∞.

    }, 5500); // 5000 –º—Å –≤—Ä–∞—â–µ–Ω–∏–µ + 500 –º—Å –∑–∞–ø–∞—Å
}

// -----------------------------------------------------
// 5. –§–£–ù–ö–¶–ò–ò –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê
// -----------------------------------------------------

function showModal(prize) {
    prizeText.textContent = `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: ${prize}`;
    resultModal.style.display = 'block';
}

function closeModal() {
    resultModal.style.display = 'none';
    // –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å Mini App
    // window.Telegram.WebApp.close();
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.onload = initTelegramApp;